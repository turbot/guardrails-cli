name: Release CLI

on:
  workflow_dispatch:
    inputs:
      releaseVersion:
        description: "The version number of the new release"
        required: true
      branchName:
        description: "The branch name from turbot-core repo"
        required: true

jobs:
  build:
    name: Build ${{ matrix.name }} binary
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: macOS
            runner: macos-latest
            artifact: build-artifact-darwin
            zip_name: turbot_cli_${{ github.event.inputs.releaseVersion }}_darwin_amd64.zip
            binary_zip: turbot_cli_${{ github.event.inputs.releaseVersion }}_darwin_amd64.zip
            binary_path: turbot-macos
            artifact_source: darwin.zip
            shell: bash
          - name: Linux
            runner: ubuntu-latest
            artifact: build-artifact-linux
            zip_name: turbot_cli_${{ github.event.inputs.releaseVersion }}_linux_amd64.zip
            binary_zip: turbot_cli_${{ github.event.inputs.releaseVersion }}_linux_amd64.zip
            binary_path: turbot-linux
            artifact_source: linux.zip
            shell: bash
          - name: Windows
            runner: windows-latest
            artifact: build-artifact-windows
            zip_name: turbot_cli_${{ github.event.inputs.releaseVersion }}_windows_amd64.zip
            binary_zip: turbot_cli_${{ github.event.inputs.releaseVersion }}_windows_amd64.zip
            binary_path: turbot-win.exe
            artifact_source: windows.zip
            shell: bash

    runs-on: ${{ matrix.runner }}
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Configure git line endings
        shell: bash
        run: |
          git config --global core.autocrlf false
          git config --global core.eol lf

      - name: Checkout turbot-core
        uses: actions/checkout@v4
        with:
          repository: turbotio/turbot-core
          ssh-key: ${{ secrets.TURBOT_CLI_DEPLOY_PRIVATE_KEY }}
          ref: ${{ github.event.inputs.branchName }}
          submodules: true

      - name: Read package.json version
        id: package-version
        uses: tyankatsu0105/read-package-version-actions@v1
        with:
          path: ${{ github.workspace }}/lib/@turbot/cli

      - name: Validate requested release version
        shell: bash
        run: |
          if [ "${{ github.event.inputs.releaseVersion }}" != "${{ steps.package-version.outputs.version }}" ]; then
            echo "ERROR: Input version '${{ github.event.inputs.releaseVersion }}' does not match package.json version '${{ steps.package-version.outputs.version }}'"
            exit 1
          fi
          echo "Version validation passed: ${{ steps.package-version.outputs.version }}"

      - name: Check for version collisions
        id: released_versions
        uses: octokit/request-action@v2.x
        with:
          route: GET /repos/:repository/releases
          repository: ${{ github.repository }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Abort if version already released
        if: ${{ contains(fromJSON(steps.released_versions.outputs.data).*.name, steps.package-version.outputs.version) }}
        run: |
          echo "WARNING: Version already released â€“ aborting build."
          exit 0

      - name: Setup Node.js 22
        uses: actions/setup-node@v6
        with:
          node-version: 22

      - name: Reconfigure git for HTTPS
        shell: bash
        run: git config --global url."https://github.com/".insteadOf ssh://git@github.com/

      - name: Install dependencies
        env:
          FONTAWESOME_NPM_AUTH_TOKEN: ${{ secrets.FONTAWESOME_NPM_AUTH_TOKEN }}
        shell: ${{ matrix.shell }}
        run: |
          npm install --no-optional
          echo "PATH=$PATH:$(pwd)/node_modules/.bin" >> $GITHUB_ENV
          echo "NODE_PATH=$GITHUB_WORKSPACE/lib" >> $GITHUB_ENV

      - name: Build CLI binary with caxa
        shell: ${{ matrix.shell }}
        run: |
          cd $GITHUB_WORKSPACE/lib/@turbot/cli
          ./compile-caxa.sh

      - name: Collect build artifacts
        shell: ${{ matrix.shell }}
        run: |
          mkdir -p ~/artifacts
          cp "$GITHUB_WORKSPACE/lib/@turbot/cli/dist/${{ matrix.binary_zip }}" "~/artifacts/${{ matrix.artifact_source }}"

      - name: Upload ${{ matrix.name }} build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ~/artifacts/${{ matrix.artifact_source }}
          if-no-files-found: error

    outputs:
      version: ${{ steps.package-version.outputs.version }}

  acceptance_tests:
    name: Acceptance Tests on ${{ matrix.platform }}
    needs: build
    strategy:
      matrix:
        platform: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.platform }}
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      TURBOT_CLI_ACC_PROFILE: acceptance_test_profile
      TURBOT_CLI_ACC_REGISTRY: turbot-stg.com
      TURBOT_CLI_ACC_ACCESS_KEY: ${{ secrets.TURBOT_CLI_ACC_ACCESS_KEY }}
      TURBOT_CLI_ACC_SECRET_KEY: ${{ secrets.TURBOT_CLI_ACC_SECRET_KEY }}
      TURBOT_CLI_ACC_WORKSPACE: ${{ secrets.TURBOT_CLI_ACC_WORKSPACE }}
      TURBOT_CLI_ACC_REGISTRY_USER: ${{ secrets.TURBOT_CLI_ACC_REGISTRY_USER }}
      TURBOT_CLI_ACC_REGISTRY_PASS: ${{ secrets.TURBOT_CLI_ACC_REGISTRY_PASS }}
      TURBOT_CLI_ACC_TEST_BINARY: setting_this_so_that_tests_are_run_on_the_binary

    steps:
      - name: Setup Node.js 16
        uses: actions/setup-node@v3
        with:
          node-version: 16

      - name: Reconfigure git for HTTPS
        run: git config --global url."https://github.com/".insteadOf ssh://git@github.com/

      - name: Prepare artifact directory
        shell: bash
        run: mkdir -p ~/artifacts

      - name: Download Linux build artifact
        if: ${{ matrix.platform == 'ubuntu-latest' }}
        uses: actions/download-artifact@v4
        with:
          name: build-artifact-linux
          path: ~/artifacts

      - name: Download macOS build artifact
        if: ${{ matrix.platform == 'macos-latest' }}
        uses: actions/download-artifact@v4
        with:
          name: build-artifact-darwin
          path: ~/artifacts

      - name: Download acceptance test suite
        uses: actions/download-artifact@v4
        with:
          name: test-artifact
          path: ~/artifacts

      - name: Rename build zip for tests
        shell: bash
        run: |
          if [[ "${{ matrix.platform }}" == "ubuntu-latest" ]]; then
            mv ~/artifacts/linux.zip ~/artifacts/build.zip
          else
            mv ~/artifacts/darwin.zip ~/artifacts/build.zip
          fi

      - name: Extract artifacts
        shell: bash
        run: |
          mkdir -p ~/build ~/tests
          unzip -q ~/artifacts/build.zip -d ~/build
          unzip -q ~/artifacts/tests.zip -d ~/tests
          echo "PATH=$PATH:$HOME/build:$HOME/tests/acceptance/bats_tests/libs/bats/libexec" >> $GITHUB_ENV
          cd ~/tests
          npm install console.table js-yaml

      - name: Setup config directory
        shell: bash
        run: |
          mkdir -p $HOME/.config/turbot
          touch $HOME/.config/turbot/config.yml
          touch $HOME/.config/turbot/credentials.yml
          touch $HOME/.config/turbot/registry.yml

      # Re-enable once tests are ready to run the binary
      # - name: Run acceptance tests
      #   shell: bash
      #   run: |
      #     chmod +x $HOME/tests/run_acceptance.sh
      #     $HOME/tests/run_acceptance.sh

  create_release:
    name: Create GitHub Release
    needs: [build, acceptance_tests]
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Create draft release
        id: create_release
        uses: actions/create-release@latest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.build.outputs.version }}
          release_name: ${{ needs.build.outputs.version }}
          body: See https://turbot.com/v5/docs/releases/cli
          draft: true
          prerelease: false

      - name: Prepare artifact staging
        run: mkdir -p $HOME/release_artifacts

      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: build-artifact-darwin
          path: $HOME/release_artifacts

      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: build-artifact-linux
          path: $HOME/release_artifacts

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: build-artifact-windows
          path: $HOME/release_artifacts

      - name: Upload macOS release asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: $HOME/release_artifacts/darwin.zip
          asset_name: turbot_cli_${{ needs.build.outputs.version }}_darwin_amd64.zip
          asset_content_type: application/zip

      - name: Upload Linux release asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: $HOME/release_artifacts/linux.zip
          asset_name: turbot_cli_${{ needs.build.outputs.version }}_linux_amd64.zip
          asset_content_type: application/zip

      - name: Upload Windows release asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: $HOME/release_artifacts/windows.zip
          asset_name: turbot_cli_${{ needs.build.outputs.version }}_windows_amd64.zip
          asset_content_type: application/zip

  clean_up:
    name: Clean Up Artifacts
    needs: create_release
    runs-on: ubuntu-latest
    steps:
      - uses: geekyeggo/delete-artifact@v1
        with:
          name: build-artifact-windows
          failOnError: true

      - uses: geekyeggo/delete-artifact@v1
        with:
          name: build-artifact-linux
          failOnError: true

      - uses: geekyeggo/delete-artifact@v1
        with:
          name: build-artifact-darwin
          failOnError: true

      - uses: geekyeggo/delete-artifact@v1
        with:
          name: test-artifact
          failOnError: true