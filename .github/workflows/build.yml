name: Build CLI Binaries

on:
  workflow_dispatch:
    inputs:
      releaseVersion:
        description: "The version number of the new release"
        required: true
      branchName:
        description: "The branch name from turbot-core repo"
        required: true

jobs:
  build:
    name: Build ${{ matrix.os }} Binary
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            binary_name: turbot-linux
            archive_name: turbot_cli_linux_amd64.tar.gz
          - os: windows-latest
            platform: windows
            binary_name: turbot-windows.exe
            archive_name: turbot_cli_windows_amd64.zip
          - os: macos-latest
            platform: macos
            binary_name: turbot-macos
            archive_name: turbot_cli_darwin_amd64.zip

    steps:
      - name: Determine branch and version
        id: inputs
        shell: bash
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "branch=${{ github.event.inputs.branchName }}" >> $GITHUB_OUTPUT
            echo "version=${{ github.event.inputs.releaseVersion }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "branch=main" >> $GITHUB_OUTPUT
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          else
            echo "branch=main" >> $GITHUB_OUTPUT
            echo "version=dev" >> $GITHUB_OUTPUT
          fi

      - name: Checkout turbot-core repository
        uses: actions/checkout@v4
        with:
          repository: turbotio/turbot-core
          ref: ${{ steps.inputs.outputs.branch }}
          token: ${{ secrets.TURBOT_CLI_DEPLOY_PRIVATE_KEY }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies in monorepo root
        run: npm ci

      - name: Install caxa
        run: npm install -g caxa

      - name: Get package version
        id: package_version
        shell: bash
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
        working-directory: lib/@turbot/cli

      - name: Create staging directory
        shell: bash
        run: |
          STAGING_DIR=".staging-caxa"
          rm -rf "$STAGING_DIR"
          mkdir -p "$STAGING_DIR"
          echo "STAGING_DIR=$STAGING_DIR" >> $GITHUB_ENV
        working-directory: lib/@turbot/cli

      - name: Copy application files
        shell: bash
        run: |
          cp turbot.js "$STAGING_DIR/"
          cp -r cmds "$STAGING_DIR/"
          cp -r lib "$STAGING_DIR/"
          cp -r inspectTemplates "$STAGING_DIR/"
          cp -r docs "$STAGING_DIR/" 2>/dev/null || true
          cp .turbotIgnore "$STAGING_DIR/" 2>/dev/null || true
          cp package.json "$STAGING_DIR/"
        working-directory: lib/@turbot/cli

      - name: Copy node_modules (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          if command -v rsync &> /dev/null; then
            rsync -a \
              --exclude='**/test/**' \
              --exclude='**/tests/**' \
              --exclude='**/__tests__/**' \
              --exclude='**/docs/**' \
              --exclude='**/examples/**' \
              --exclude='**/*.md' \
              --exclude='**/.git/**' \
              ../../../node_modules/ "$STAGING_DIR/node_modules/"
          else
            cp -R ../../../node_modules "$STAGING_DIR/"
            find "$STAGING_DIR/node_modules" -type d \( -name test -o -name tests -o -name __tests__ -o -name docs -o -name examples \) -prune -exec rm -rf {} +
            find "$STAGING_DIR/node_modules" -type f -name '*.md' -delete
          fi
        working-directory: lib/@turbot/cli

      - name: Copy node_modules (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Copy-Item -Path "../../../node_modules" -Destination "$env:STAGING_DIR/" -Recurse -Force
          Get-ChildItem -Path "$env:STAGING_DIR/node_modules" -Include test,tests,__tests__,docs,examples -Recurse -Directory | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
          Get-ChildItem -Path "$env:STAGING_DIR/node_modules" -Filter "*.md" -Recurse -File | Remove-Item -Force -ErrorAction SilentlyContinue
        working-directory: lib/@turbot/cli

      - name: Remove unused optional modules
        shell: bash
        run: |
          rm -rf \
            "$STAGING_DIR/node_modules/pg-native" \
            "$STAGING_DIR/node_modules/pg-query-stream" \
            "$STAGING_DIR/node_modules/pg-cursor" \
            "$STAGING_DIR/node_modules/mysql" \
            "$STAGING_DIR/node_modules/mysql2" \
            "$STAGING_DIR/node_modules/oracledb" \
            "$STAGING_DIR/node_modules/mariasql" \
            "$STAGING_DIR/node_modules/tedious" \
            "$STAGING_DIR/node_modules/sqlite3" \
            "$STAGING_DIR/node_modules/node-sqlite3" 2>/dev/null || true
        working-directory: lib/@turbot/cli

      - name: Bundle @turbot packages
        shell: bash
        run: |
          # Create @turbot directory
          mkdir -p "$STAGING_DIR/node_modules/@turbot"

          # List of local packages to bundle
          declare -a local_packages=(
            "cache" "compile-mod" "compose" "constants" "data-utils" "errors"
            "events" "filter-parser" "filter-parser-2" "flags" "fn" "graphql"
            "graphql-typedefs" "inline" "internal-utils" "jq-node" "ldap"
            "license" "locks" "log" "memory-cache" "mocha" 
            "mockserver-vcr-recorder-mocha" "mod" "nunjucks-core" "ocl" "rdb"
            "rdb-action-types" "rdb-actions" "rdb-active-grants" 
            "rdb-control-categories" "rdb-control-pivots" "rdb-control-types"
            "rdb-controls" "rdb-daily-stats" "rdb-directories" "rdb-favorites"
            "rdb-folders" "rdb-grants" "rdb-guardrail-accounts" 
            "rdb-guardrail-control-types" "rdb-guardrails" "rdb-iam" 
            "rdb-loaders" "rdb-locks" "rdb-membership-hierarchy" "rdb-mods"
            "rdb-navigation-hierarchy" "rdb-notifications" "rdb-permission-levels"
            "rdb-permission-types" "rdb-policies" "rdb-policy-hierarchy"
            "rdb-policy-types" "rdb-policy-value-pivots" "rdb-policy-values"
            "rdb-prevention-categories" "rdb-prevention-objectives" 
            "rdb-prevention-rule-examples" "rdb-prevention-rules" 
            "rdb-prevention-scores" "rdb-prevention-types" "rdb-process-logs"
            "rdb-processes" "rdb-processes-history" "rdb-query-builder"
            "rdb-resource-categories" "rdb-resource-groups" 
            "rdb-resource-interfaces" "rdb-resource-types" "rdb-resources"
            "rdb-rollout-accounts" "rdb-rollout-guardrails" "rdb-rollouts"
            "rdb-scheduled-actions" "rdb-tags" "rdb-tenant-metadata"
            "rdb-turbot-secrets" "rdb-watch-pivots" "rdb-watch-rules"
            "rdb-watches" "redis" "runnable-test-helper" "tdb-pool" "utils"
            "validator"
          )

          for pkg in "${local_packages[@]}"; do
            if [[ -d ../../../lib/@turbot/$pkg ]]; then
              echo "ðŸ“¦ Bundling @turbot/$pkg"
              rm -rf "$STAGING_DIR/node_modules/@turbot/$pkg"
              if command -v rsync &> /dev/null; then
                mkdir -p "$STAGING_DIR/node_modules/@turbot/$pkg"
                rsync -a \
                  --exclude 'node_modules' \
                  --exclude '.git' \
                  --exclude 'dist' \
                  --exclude 'test' \
                  --exclude 'tests' \
                  --exclude '__tests__' \
                  "../../../lib/@turbot/$pkg/" "$STAGING_DIR/node_modules/@turbot/$pkg/"
              else
                cp -R "../../../lib/@turbot/$pkg" "$STAGING_DIR/node_modules/@turbot/"
                rm -rf "$STAGING_DIR/node_modules/@turbot/$pkg/node_modules" 2>/dev/null || true
                rm -rf "$STAGING_DIR/node_modules/@turbot/$pkg"/{test,tests,__tests__,dist} 2>/dev/null || true
              fi
            fi
          done
        working-directory: lib/@turbot/cli

      - name: Create bootstrap script
        shell: bash
        run: |
          cat > "$STAGING_DIR/bootstrap.js" << 'EOF'
          const path = require("path");
          const Module = require("module");

          // Set up module paths BEFORE loading app
          const appDir = __dirname;
          const nodeModulesPath = path.join(appDir, "node_modules");
          const atTurbotPath = path.join(nodeModulesPath, "@turbot");
          const localLibPath = path.join(appDir, "lib");

          const extraPaths = [nodeModulesPath, atTurbotPath, localLibPath];

          extraPaths.forEach((p) => {
            module.paths.unshift(p);
            Module.globalPaths.unshift(p);
          });

          const existingNodePath = process.env.NODE_PATH ? process.env.NODE_PATH.split(path.delimiter) : [];
          const mergedNodePath = [...extraPaths, ...existingNodePath.filter(Boolean)];
          process.env.NODE_PATH = mergedNodePath.join(path.delimiter);
          Module._initPaths();

          if (!process.env.TURBOT_CORE) {
            process.env.TURBOT_CORE = appDir;
          }

          // Set argv[1] to show 'turbot' instead of 'bootstrap.js'
          process.argv[1] = "turbot";

          // Load the app
          require("./turbot.js");
          EOF
        working-directory: lib/@turbot/cli

      - name: Build binary with caxa
        shell: bash
        run: |
          mkdir -p dist
          caxa \
            --input "$STAGING_DIR" \
            --output "dist/${{ matrix.binary_name }}" \
            --no-dedupe \
            -- "node" "{{caxa}}/bootstrap.js"
        working-directory: lib/@turbot/cli

      - name: Create archive (Linux)
        if: matrix.platform == 'linux'
        shell: bash
        run: |
          cd dist
          tar -czf "turbot_cli_${{ steps.package_version.outputs.version }}_linux_amd64.tar.gz" turbot-linux
        working-directory: lib/@turbot/cli

      - name: Create archive (Windows/macOS)
        if: matrix.platform != 'linux'
        shell: bash
        run: |
          cd dist
          if [[ "${{ matrix.platform }}" == "windows" ]]; then
            7z a "turbot_cli_${{ steps.package_version.outputs.version }}_windows_amd64.zip" turbot-windows.exe
          else
            zip "turbot_cli_${{ steps.package_version.outputs.version }}_darwin_amd64.zip" turbot-macos
          fi
        working-directory: lib/@turbot/cli

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: turbot-cli-${{ matrix.platform }}
          path: lib/@turbot/cli/dist/${{ matrix.binary_name }}
          retention-days: 30

      - name: Upload archive artifact
        uses: actions/upload-artifact@v4
        with:
          name: turbot-cli-${{ matrix.platform }}-archive
          path: lib/@turbot/cli/dist/turbot_cli_*
          retention-days: 30

      - name: Cleanup
        if: always()
        shell: bash
        run: |
          rm -rf "$STAGING_DIR"
        working-directory: lib/@turbot/cli

  release:
    name: Create Release
    needs: build
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout guardrails-cli repository
        uses: actions/checkout@v4

      - name: Determine release version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.releaseVersion }}" >> $GITHUB_OUTPUT
            echo "tag=v${{ github.event.inputs.releaseVersion }}" >> $GITHUB_OUTPUT
          else
            VERSION=${GITHUB_REF#refs/tags/v}
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.version }}
          files: |
            artifacts/turbot-cli-*-archive/*
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
