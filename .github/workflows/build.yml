name: Build CLI Binaries

on:
  workflow_dispatch:
    inputs:
      releaseVersion:
        description: "The version number of the new release (e.g., 1.2.3)"
        required: true
      turbotCoreBranch:
        description: "The branch name from turbotio/turbot-core repo where CLI package is located"
        required: true
        default: "main"

jobs:
  build:
    name: Build ${{ matrix.platform }} Binary
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            binary_name: turbot-linux
          - os: windows-latest
            platform: windows
            binary_name: turbot-windows.exe
          - os: macos-latest
            platform: macos
            binary_name: turbot-macos

    steps:
      - name: Checkout turbot-core repository
        uses: actions/checkout@v4
        with:
          repository: turbotio/turbot-core
          ref: ${{ github.event.inputs.turbotCoreBranch }}
          token: ${{ secrets.TURBOT_CLI_DEPLOY_PRIVATE_KEY }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies in turbot-core monorepo
        run: npm ci

      - name: Install caxa globally
        run: npm install -g caxa

      - name: Verify package version matches input
        shell: bash
        run: |
          PKG_VERSION=$(node -p "require('./package.json').version")
          INPUT_VERSION="${{ github.event.inputs.releaseVersion }}"
          echo "Package version: $PKG_VERSION"
          echo "Input version: $INPUT_VERSION"
          if [ "$PKG_VERSION" != "$INPUT_VERSION" ]; then
            echo "âš ï¸  Warning: Package version ($PKG_VERSION) does not match input version ($INPUT_VERSION)"
            echo "Please update package.json version to match the release version."
          fi
        working-directory: lib/@turbot/cli

      - name: Make compile script executable
        shell: bash
        run: chmod +x compile-caxa.sh
        working-directory: lib/@turbot/cli

      - name: Modify compile-caxa.sh for cross-platform builds
        shell: bash
        run: |
          # Create a modified version that builds for the current platform
          cat > compile-caxa-ci.sh << 'SCRIPT_END'
          #!/bin/bash
          set -e

          echo "ðŸ”¨ Building Turbot CLI with caxa for ${{ matrix.platform }}"

          PACKAGE_VERSION=$(node -p -e "require('./package.json').version")
          PLATFORM="${{ matrix.platform }}"
          BINARY_NAME="${{ matrix.binary_name }}"

          # Create staging directory
          STAGING_DIR=".staging-caxa"
          rm -rf "$STAGING_DIR"
          mkdir -p "$STAGING_DIR"

          echo "ðŸ“ Preparing for caxa packaging..."

          # Copy app and dependencies to staging
          cp turbot.js "$STAGING_DIR/"
          cp -r cmds "$STAGING_DIR/"
          cp -r lib "$STAGING_DIR/"
          cp -r inspectTemplates "$STAGING_DIR/"
          cp -r docs "$STAGING_DIR/" 2>/dev/null || true
          cp .turbotIgnore "$STAGING_DIR/" 2>/dev/null || true
          cp package.json "$STAGING_DIR/"

          # Copy the Node.js runtime
          NODE_RUNTIME=$(command -v node)
          if [[ -z "$NODE_RUNTIME" ]]; then
            echo "âŒ Unable to locate Node.js runtime on the build machine."
            exit 1
          fi
          cp "$NODE_RUNTIME" "$STAGING_DIR/node"
          chmod +x "$STAGING_DIR/node"

          # Copy node_modules
          echo "ðŸ“‹ Copying dependencies..."
          if command -v rsync &> /dev/null; then
            rsync -a \
              --exclude='**/test/**' \
              --exclude='**/tests/**' \
              --exclude='**/__tests__/**' \
              --exclude='**/docs/**' \
              --exclude='**/examples/**' \
              --exclude='**/*.md' \
              --exclude='**/.git/**' \
              ../../../node_modules/ "$STAGING_DIR/node_modules/"
          else
            cp -R ../../../node_modules "$STAGING_DIR/"
            find "$STAGING_DIR/node_modules" -type d \( -name test -o -name tests -o -name __tests__ -o -name docs -o -name examples \) -prune -exec rm -rf {} + 2>/dev/null || true
            find "$STAGING_DIR/node_modules" -type f -name '*.md' -delete 2>/dev/null || true
          fi

          # Remove optional heavy drivers
          echo "ðŸ§¹ Removing unused optional modules..."
          rm -rf \
            "$STAGING_DIR/node_modules/pg-native" \
            "$STAGING_DIR/node_modules/pg-query-stream" \
            "$STAGING_DIR/node_modules/pg-cursor" \
            "$STAGING_DIR/node_modules/mysql" \
            "$STAGING_DIR/node_modules/mysql2" \
            "$STAGING_DIR/node_modules/oracledb" \
            "$STAGING_DIR/node_modules/mariasql" \
            "$STAGING_DIR/node_modules/tedious" \
            "$STAGING_DIR/node_modules/sqlite3" \
            "$STAGING_DIR/node_modules/node-sqlite3" 2>/dev/null || true

          # Bundle internal @turbot packages
          declare -a local_packages=(
            "cache" "compile-mod" "compose" "constants" "data-utils" "errors"
            "events" "filter-parser" "filter-parser-2" "flags" "fn" "graphql"
            "graphql-typedefs" "inline" "internal-utils" "jq-node" "ldap"
            "license" "locks" "log" "memory-cache" "mocha" 
            "mockserver-vcr-recorder-mocha" "mod" "nunjucks-core" "ocl" "rdb"
            "rdb-action-types" "rdb-actions" "rdb-active-grants" 
            "rdb-control-categories" "rdb-control-pivots" "rdb-control-types"
            "rdb-controls" "rdb-daily-stats" "rdb-directories" "rdb-favorites"
            "rdb-folders" "rdb-grants" "rdb-guardrail-accounts" 
            "rdb-guardrail-control-types" "rdb-guardrails" "rdb-iam" 
            "rdb-loaders" "rdb-locks" "rdb-membership-hierarchy" "rdb-mods"
            "rdb-navigation-hierarchy" "rdb-notifications" "rdb-permission-levels"
            "rdb-permission-types" "rdb-policies" "rdb-policy-hierarchy"
            "rdb-policy-types" "rdb-policy-value-pivots" "rdb-policy-values"
            "rdb-prevention-categories" "rdb-prevention-objectives" 
            "rdb-prevention-rule-examples" "rdb-prevention-rules" 
            "rdb-prevention-scores" "rdb-prevention-types" "rdb-process-logs"
            "rdb-processes" "rdb-processes-history" "rdb-query-builder"
            "rdb-resource-categories" "rdb-resource-groups" 
            "rdb-resource-interfaces" "rdb-resource-types" "rdb-resources"
            "rdb-rollout-accounts" "rdb-rollout-guardrails" "rdb-rollouts"
            "rdb-scheduled-actions" "rdb-tags" "rdb-tenant-metadata"
            "rdb-turbot-secrets" "rdb-watch-pivots" "rdb-watch-rules"
            "rdb-watches" "redis" "runnable-test-helper" "tdb-pool" "utils"
            "validator"
          )

          mkdir -p "$STAGING_DIR/node_modules/@turbot"

          for pkg in "${local_packages[@]}"; do
            if [[ -d ../../../lib/@turbot/$pkg ]]; then
              echo "ðŸ“¦ Bundling @turbot/$pkg"
              rm -rf "$STAGING_DIR/node_modules/@turbot/$pkg"
              if command -v rsync &> /dev/null; then
                mkdir -p "$STAGING_DIR/node_modules/@turbot/$pkg"
                rsync -a \
                  --exclude 'node_modules' \
                  --exclude '.git' \
                  --exclude 'dist' \
                  --exclude 'test' \
                  --exclude 'tests' \
                  --exclude '__tests__' \
                  "../../../lib/@turbot/$pkg/" "$STAGING_DIR/node_modules/@turbot/$pkg/"
              else
                cp -R "../../../lib/@turbot/$pkg" "$STAGING_DIR/node_modules/@turbot/"
                rm -rf "$STAGING_DIR/node_modules/@turbot/$pkg/node_modules" 2>/dev/null || true
                rm -rf "$STAGING_DIR/node_modules/@turbot/$pkg"/{test,tests,__tests__,dist} 2>/dev/null || true
              fi
            fi
          done

          # Create bootstrap script
          cat > "$STAGING_DIR/bootstrap.js" << 'EOF'
          const path = require("path");
          const Module = require("module");

          const appDir = __dirname;
          const nodeModulesPath = path.join(appDir, "node_modules");
          const atTurbotPath = path.join(nodeModulesPath, "@turbot");
          const localLibPath = path.join(appDir, "lib");

          const extraPaths = [nodeModulesPath, atTurbotPath, localLibPath];

          extraPaths.forEach((p) => {
            module.paths.unshift(p);
            Module.globalPaths.unshift(p);
          });

          const existingNodePath = process.env.NODE_PATH ? process.env.NODE_PATH.split(path.delimiter) : [];
          const mergedNodePath = [...extraPaths, ...existingNodePath.filter(Boolean)];
          process.env.NODE_PATH = mergedNodePath.join(path.delimiter);
          Module._initPaths();

          if (!process.env.TURBOT_CORE) {
            process.env.TURBOT_CORE = appDir;
          }

          process.argv[1] = "turbot";
          require("./turbot.js");
          EOF

          # Create launcher
          cat > "$STAGING_DIR/bootstrap-launcher.js" << 'EOF'
          const os = require("os");
          const path = require("path");
          const fs = require("fs");

          function resolveCacheDir() {
            if (process.platform === "win32") {
              const base = process.env.LOCALAPPDATA || path.join(os.homedir(), "AppData", "Local");
              return path.join(base, "TurbotCLI", "cache");
            }
            return path.join(os.homedir(), ".cache", "turbot-cli");
          }

          const cacheDir = process.env.CAXA_TMPDIR || resolveCacheDir();
          fs.mkdirSync(cacheDir, { recursive: true });
          process.env.CAXA_TMPDIR = cacheDir;

          require("./bootstrap.js");
          EOF

          mkdir -p dist

          # Build with caxa
          echo "ðŸ”¨ Building ${PLATFORM} binary..."
          caxa \
            --input "$STAGING_DIR" \
            --output "dist/$BINARY_NAME" \
            --no-dedupe \
            -- "{{caxa}}/node" "{{caxa}}/bootstrap-launcher.js"

          echo "âœ… ${PLATFORM} binary created: dist/$BINARY_NAME"

          # Create archive based on platform
          cd dist
          if [[ "$PLATFORM" == "linux" ]]; then
            tar -czf "turbot_cli_${PACKAGE_VERSION}_linux_amd64.tar.gz" "$BINARY_NAME"
            echo "âœ… Archive: turbot_cli_${PACKAGE_VERSION}_linux_amd64.tar.gz"
          elif [[ "$PLATFORM" == "windows" ]]; then
            zip "turbot_cli_${PACKAGE_VERSION}_windows_amd64.zip" "$BINARY_NAME"
            echo "âœ… Archive: turbot_cli_${PACKAGE_VERSION}_windows_amd64.zip"
          else
            zip "turbot_cli_${PACKAGE_VERSION}_darwin_amd64.zip" "$BINARY_NAME"
            echo "âœ… Archive: turbot_cli_${PACKAGE_VERSION}_darwin_amd64.zip"
          fi
          cd ..

          # Cleanup
          rm -rf "$STAGING_DIR"
          echo "ðŸŽ‰ Build complete!"
          SCRIPT_END

          chmod +x compile-caxa-ci.sh
        working-directory: lib/@turbot/cli

      - name: Build binary
        shell: bash
        run: ./compile-caxa-ci.sh
        working-directory: lib/@turbot/cli

      - name: Verify binary was created
        shell: bash
        run: |
          if [ -f "dist/${{ matrix.binary_name }}" ]; then
            SIZE=$(du -h "dist/${{ matrix.binary_name }}" | cut -f1)
            echo "âœ… Binary verified: ${{ matrix.binary_name }} ($SIZE)"
            ls -lh dist/
          else
            echo "âŒ Binary not found: dist/${{ matrix.binary_name }}"
            exit 1
          fi
        working-directory: lib/@turbot/cli

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: turbot-cli-${{ matrix.platform }}-binary
          path: lib/@turbot/cli/dist/${{ matrix.binary_name }}
          retention-days: 30

      - name: Upload archive artifact
        uses: actions/upload-artifact@v4
        with:
          name: turbot-cli-${{ matrix.platform }}-archive
          path: lib/@turbot/cli/dist/turbot_cli_*.tar.gz
          retention-days: 30
        if: matrix.platform == 'linux'

      - name: Upload archive artifact
        uses: actions/upload-artifact@v4
        with:
          name: turbot-cli-${{ matrix.platform }}-archive
          path: lib/@turbot/cli/dist/turbot_cli_*.zip
          retention-days: 30
        if: matrix.platform != 'linux'

  create-release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout guardrails-cli repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display artifact structure
        run: |
          echo "ðŸ“¦ Downloaded artifacts:"
          ls -R artifacts/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.event.inputs.releaseVersion }}
          name: Release v${{ github.event.inputs.releaseVersion }}
          body: |
            ## CLI Binary Release v${{ github.event.inputs.releaseVersion }}

            Built from:
            - **turbot-core branch**: `${{ github.event.inputs.turbotCoreBranch }}`
            - **guardrails-cli branch**: `${{ github.ref_name }}`

            ### Downloads
            - **Linux**: `turbot_cli_${{ github.event.inputs.releaseVersion }}_linux_amd64.tar.gz`
            - **macOS**: `turbot_cli_${{ github.event.inputs.releaseVersion }}_darwin_amd64.zip`
            - **Windows**: `turbot_cli_${{ github.event.inputs.releaseVersion }}_windows_amd64.zip`

            ### Installation

            #### Linux/macOS
            ```bash
            # Extract the archive
            tar -xzf turbot_cli_${{ github.event.inputs.releaseVersion }}_linux_amd64.tar.gz  # Linux
            unzip turbot_cli_${{ github.event.inputs.releaseVersion }}_darwin_amd64.zip      # macOS

            # Move to PATH
            sudo mv turbot-* /usr/local/bin/turbot
            sudo chmod +x /usr/local/bin/turbot
            ```

            #### Windows
            ```powershell
            # Extract the zip and add the directory to your PATH
            ```
          files: |
            artifacts/turbot-cli-linux-archive/*
            artifacts/turbot-cli-macos-archive/*
            artifacts/turbot-cli-windows-archive/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  summary:
    name: Build Summary
    needs: [build, create-release]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸŽ‰ CLI Build Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Release Version**: v${{ github.event.inputs.releaseVersion }}" >> $GITHUB_STEP_SUMMARY
          echo "- **turbot-core Branch**: \`${{ github.event.inputs.turbotCoreBranch }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **guardrails-cli Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Linux binary (amd64)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… macOS binary (amd64)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Windows binary (amd64)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Release" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [View Release](https://github.com/turbot/guardrails-cli/releases/tag/v${{ github.event.inputs.releaseVersion }})" >> $GITHUB_STEP_SUMMARY
