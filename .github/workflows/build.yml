name: Release CLI

on:
  workflow_dispatch:
    inputs:
      releaseVersion:
        description: "The version number of the new release"
        required: true
      branchName:
        description: "The branch name from turbot-core repo"
        required: true

jobs:
  prepare_tests:
    name: Package Acceptance Tests
    runs-on: ubuntu-latest
    env:
      ARTIFACT_DIR: ${{ runner.temp }}/release-cli-tests
    steps:
      - name: Checkout turbot-core
        uses: actions/checkout@v4
        with:
          repository: turbotio/turbot-core
          ssh-key: ${{ secrets.TURBOT_CLI_DEPLOY_PRIVATE_KEY }}
          ref: ${{ github.event.inputs.branchName }}
          submodules: true

      - name: Create tests archive
        shell: bash
        run: |
          mkdir -p "$ARTIFACT_DIR"
          cd lib/@turbot/cli
          zip -qr "$ARTIFACT_DIR/tests.zip" test

      - name: Upload acceptance test suite
        uses: actions/upload-artifact@v4
        with:
          name: test-artifact
          path: ${{ env.ARTIFACT_DIR }}/tests.zip
          if-no-files-found: error

  build:
    name: Build ${{ matrix.name }} binary
    runs-on: ${{ matrix.runner }}
    needs: prepare_tests
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      ARTIFACT_DIR: ${{ runner.temp }}/release-cli-${{ matrix.target_os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: macOS
            runner: macos-latest
            target_os: macos
            archive_format: zip
            artifact_name: build-artifact-darwin
            artifact_basename: darwin.zip
            release_suffix: darwin_amd64
          - name: Linux
            runner: ubuntu-latest
            target_os: linux
            archive_format: zip
            artifact_name: build-artifact-linux
            artifact_basename: linux.zip
            release_suffix: linux_amd64
          - name: Windows
            runner: windows-latest
            target_os: windows
            archive_format: zip
            artifact_name: build-artifact-windows
            artifact_basename: windows.zip
            release_suffix: windows_amd64
    steps:
      - name: Configure git line endings
        shell: bash
        run: |
          git config --global core.autocrlf false
          git config --global core.eol lf

      - name: Checkout turbot-core
        uses: actions/checkout@v4
        with:
          repository: turbotio/turbot-core
          ssh-key: ${{ secrets.TURBOT_CLI_DEPLOY_PRIVATE_KEY }}
          ref: ${{ github.event.inputs.branchName }}
          submodules: true

      - name: Read package.json version
        id: package-version
        uses: tyankatsu0105/read-package-version-actions@v1
        with:
          path: ${{ github.workspace }}/lib/@turbot/cli

      - name: Validate requested release version
        shell: bash
        run: |
          if [ "${{ github.event.inputs.releaseVersion }}" != "${{ steps.package-version.outputs.version }}" ]; then
            echo "ERROR: Input version '${{ github.event.inputs.releaseVersion }}' does not match package.json version '${{ steps.package-version.outputs.version }}'"
            exit 1
          fi
          echo "Version validation passed: ${{ steps.package-version.outputs.version }}"

      - name: Check for version collisions
        id: released_versions
        uses: octokit/request-action@v2.x
        with:
          route: GET /repos/:repository/releases
          repository: ${{ github.repository }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Abort if version already released
        if: ${{ contains(fromJSON(steps.released_versions.outputs.data).*.name, steps.package-version.outputs.version) }}
        run: |
          echo "WARNING: Version already released â€“ aborting build."
          exit 0

      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Reconfigure git for HTTPS
        shell: bash
        run: git config --global url."https://github.com/".insteadOf ssh://git@github.com/

      - name: Install dependencies
        env:
          FONTAWESOME_NPM_AUTH_TOKEN: ${{ secrets.FONTAWESOME_NPM_AUTH_TOKEN }}
        shell: bash
        run: |
          npm install --omit=optional
          echo "PATH=$PATH:$(pwd)/node_modules/.bin" >> $GITHUB_ENV
          echo "NODE_PATH=$GITHUB_WORKSPACE/lib" >> $GITHUB_ENV

      - name: Install caxa
        shell: bash
        run: npm install --global caxa

      - name: Build CLI binary with caxa
        shell: bash
        working-directory: lib/@turbot/cli
        env:
          TARGET_OS: ${{ matrix.target_os }}
          TARGET_ARCH: amd64
          TARGET_ARCHIVE_FORMAT: ${{ matrix.archive_format }}
        run: |
          chmod +x compile-caxa.sh
          ./compile-caxa.sh

      - name: Collect build artifacts
        shell: bash
        env:
          VERSION: ${{ github.event.inputs.releaseVersion }}
        run: |
          mkdir -p "$ARTIFACT_DIR"
          ARCHIVE_NAME="turbot_cli_${VERSION}_${{ matrix.release_suffix }}.zip"
          cp "$GITHUB_WORKSPACE/lib/@turbot/cli/dist/$ARCHIVE_NAME" "$ARTIFACT_DIR/${{ matrix.artifact_basename }}"

      - name: Upload ${{ matrix.name }} build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ env.ARTIFACT_DIR }}/{{ matrix.artifact_basename }}
          if-no-files-found: error

    outputs:
      version: ${{ steps.package-version.outputs.version }}

  acceptance_tests:
    name: Acceptance Tests on ${{ matrix.platform }}
    needs: [build, prepare_tests]
    strategy:
      matrix:
        platform: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.platform }}
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      TURBOT_CLI_ACC_PROFILE: acceptance_test_profile
      ARTIFACT_DIR: ${{ runner.temp }}/release-cli-acceptance
      TURBOT_CLI_ACC_REGISTRY: turbot-stg.com
      TURBOT_CLI_ACC_ACCESS_KEY: ${{ secrets.TURBOT_CLI_ACC_ACCESS_KEY }}
      TURBOT_CLI_ACC_SECRET_KEY: ${{ secrets.TURBOT_CLI_ACC_SECRET_KEY }}
      TURBOT_CLI_ACC_WORKSPACE: ${{ secrets.TURBOT_CLI_ACC_WORKSPACE }}
      TURBOT_CLI_ACC_REGISTRY_USER: ${{ secrets.TURBOT_CLI_ACC_REGISTRY_USER }}
      TURBOT_CLI_ACC_REGISTRY_PASS: ${{ secrets.TURBOT_CLI_ACC_REGISTRY_PASS }}
      TURBOT_CLI_ACC_TEST_BINARY: setting_this_so_that_tests_are_run_on_the_binary
    steps:
      - name: Setup Node.js 16
        uses: actions/setup-node@v3
        with:
          node-version: 16

      - name: Reconfigure git for HTTPS
        run: git config --global url."https://github.com/".insteadOf ssh://git@github.com/

      - name: Prepare artifact directory
        shell: bash
        run: mkdir -p "$ARTIFACT_DIR"

      - name: Download Linux build artifact
        if: ${{ matrix.platform == 'ubuntu-latest' }}
        uses: actions/download-artifact@v4
        with:
          name: build-artifact-linux
          path: ${{ env.ARTIFACT_DIR }}

      - name: Download macOS build artifact
        if: ${{ matrix.platform == 'macos-latest' }}
        uses: actions/download-artifact@v4
        with:
          name: build-artifact-darwin
          path: ${{ env.ARTIFACT_DIR }}

      - name: Download acceptance test suite
        uses: actions/download-artifact@v4
        with:
          name: test-artifact
          path: ${{ env.ARTIFACT_DIR }}

      - name: Rename build archive for tests
        shell: bash
        run: |
          if [[ "${{ matrix.platform }}" == "ubuntu-latest" ]]; then
            mv "$ARTIFACT_DIR/linux.zip" "$ARTIFACT_DIR/build.zip"
          else
            mv "$ARTIFACT_DIR/darwin.zip" "$ARTIFACT_DIR/build.zip"
          fi

      - name: Extract artifacts
        shell: bash
        run: |
          BUILD_DIR="$ARTIFACT_DIR/build"
          TESTS_DIR="$ARTIFACT_DIR/tests"
          mkdir -p "$BUILD_DIR" "$TESTS_DIR"
          unzip -q "$ARTIFACT_DIR/build.zip" -d "$BUILD_DIR"
          unzip -q "$ARTIFACT_DIR/tests.zip" -d "$TESTS_DIR"
          echo "PATH=$PATH:$BUILD_DIR:$TESTS_DIR/acceptance/bats_tests/libs/bats/libexec" >> $GITHUB_ENV
          cd "$TESTS_DIR"
          npm install console.table js-yaml

      - name: Setup config directory
        shell: bash
        run: |
          mkdir -p $HOME/.config/turbot
          touch $HOME/.config/turbot/config.yml
          touch $HOME/.config/turbot/credentials.yml
          touch $HOME/.config/turbot/registry.yml

      # Re-enable once tests are ready to run the binary
      # - name: Run acceptance tests
      #   shell: bash
      #   run: |
      #     chmod +x $HOME/tests/run_acceptance.sh
      #     $HOME/tests/run_acceptance.sh

  create_release:
    name: Create GitHub Release
    needs: [build, acceptance_tests]
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      ARTIFACT_DIR: ${{ runner.temp }}/release-cli-final
    steps:
      - name: Create draft release
        id: create_release
        uses: actions/create-release@latest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.build.outputs.version }}
          release_name: ${{ needs.build.outputs.version }}
          body: See https://turbot.com/v5/docs/releases/cli
          draft: true
          prerelease: false

      - name: Prepare artifact staging
        run: mkdir -p "$ARTIFACT_DIR"

      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: build-artifact-darwin
          path: ${{ env.ARTIFACT_DIR }}

      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: build-artifact-linux
          path: ${{ env.ARTIFACT_DIR }}

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: build-artifact-windows
          path: ${{ env.ARTIFACT_DIR }}

      - name: Upload macOS release asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ env.ARTIFACT_DIR }}/darwin.zip
          asset_name: turbot_cli_${{ needs.build.outputs.version }}_darwin_amd64.zip
          asset_content_type: application/zip

      - name: Upload Linux release asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ env.ARTIFACT_DIR }}/linux.zip
          asset_name: turbot_cli_${{ needs.build.outputs.version }}_linux_amd64.zip
          asset_content_type: application/zip

      - name: Upload Windows release asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ env.ARTIFACT_DIR }}/windows.zip
          asset_name: turbot_cli_${{ needs.build.outputs.version }}_windows_amd64.zip
          asset_content_type: application/zip

  clean_up:
    name: Clean Up Artifacts
    needs: create_release
    runs-on: ubuntu-latest
    steps:
      - uses: geekyeggo/delete-artifact@v1
        with:
          name: build-artifact-windows
          failOnError: true

      - uses: geekyeggo/delete-artifact@v1
        with:
          name: build-artifact-linux
          failOnError: true

      - uses: geekyeggo/delete-artifact@v1
        with:
          name: build-artifact-darwin
          failOnError: true

      - uses: geekyeggo/delete-artifact@v1
        with:
          name: test-artifact
          failOnError: true
